<div class="container-xl full">
    <div class="row pt-3">
        <div class="col">
          <div class="info text-truncate">Permanently removing data generated by this account.</div>
        </div>
      </div>
    <div class="row pt-3">
        <div class="col">
            <div class="alert alert-danger">
                <fa-icon icon="exclamation-triangle" class="pr-1"></fa-icon> <strong>This is an irreversiable action!</strong>
                The selected data will be removed over time in the background.
            </div>
        </div>
    </div>

    <div class="row pt-2">
        <div class="col">
            <form [formGroup]="removalForm" (submit)="deleteData()">
                <div class="form-group d-none">
                    <div class="input-group">
                        <input name="datepicker" class="form-control" ngbDatepicker #datepicker="ngbDatepicker"
                            [autoClose]="'outside'" (dateSelect)="onDateSelection($event)" [displayMonths]="2"
                            [dayTemplate]="t" [footerTemplate]="f" outsideDays="hidden" [startDate]="fromDate!"
                            tabindex="-1" container="body" [positionTarget]="dpTarget">
                        <ng-template #t let-date let-focused="focused">
                            <span class="custom-day" [class.focused]="focused" [class.range]="isRange(date)"
                                [class.faded]="isHovered(date) || isInside(date)" (mouseenter)="hoveredDate = date"
                                (mouseleave)="hoveredDate = null">
                                {{ date.day }}
                            </span>
                        </ng-template>
                        <ng-template #f>
                            <button (click)="datepicker.close()"
                                class="btn btn-sm btn-outline-primary float-right mr-2 mb-2">Close</button>
                        </ng-template>
                    </div>
                </div>
                <!-- Select 1 dataset -->
                <div class="form-row mt-2">
                    <div class="form-group col-sm-12">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend">
                                <span class="input-group-text" (click)="ignore($event)">Dataset</span>
                            </div>
                            <ng-select class="myControl-sm" [items]="datasetSource.items$ | async" bindLabel="name"
                                placeholder="Choose a dataset" formControlName="dataset" [virtualScroll]="true"
                                (scrollToEnd)="datasetSource.fetchMissingItems()"
                                [typeahead]="datasetSource.queryRemote$" [compareWith]="datasetSource.compareWith"
                                [trackByFn]="datasetSource.trackByFn"
                                typeToSearchText="Please enter 2 or more characters" labelForId="datasets" #dsInput>
                                <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                    <span class="ng-value-label tag">{{item.name}}</span>
                                    <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
                                </ng-template>
                            </ng-select>
                        </div>
                        <div *ngIf="fDataset.errors?.required && fDataset.touched" class="error-txt">
                            Please select a dataset
                        </div>
                    </div>
                </div>

                <!-- Select metrics -->
                <div class="form-row mt-2">
                    <div class="form-group col-sm-12">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend">
                                <span class="input-group-text" (click)="ignore($event)">Metrics</span>
                            </div>
                            <ng-select class="myControl-sm" [items]="metricSource?.items$ | async" bindLabel="id"
                                bindValue="id" placeholder="Select metrics" formControlName="metrics"
                                [virtualScroll]="true" (scrollToEnd)="metricSource?.fetchMissingItems()"
                                [typeahead]="metricSource?.queryRemote$" [trackByFn]="metricSource?.trackByFn"
                                typeToSearchText="Please enter 2 or more characters"
                                [compareWith]="metricSource?.compareWith" labelForId="restrictions" [multiple]="true"
                                [closeOnSelect]="false" (close)="metricSource?.resetQuery()">
                                <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                    <span class="ng-value-label tag">{{item.id}}</span>
                                    <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
                                </ng-template>
                                <ng-template ng-option-tmp let-item="item" let-item$="item$" let-index="index">
                                    <input id="item-{{index}}" type="checkbox" [checked]="item$.selected" /> {{item.id}}
                                </ng-template>
                                <ng-template ng-footer-tmp>
                                    <button class="btn btn-xs btn-outline-secondary mr-2"
                                        (click)="selectAllMetrics()">Select all</button>
                                    <button class="btn btn-xs btn-outline-secondary"
                                        (click)="deselectAllMetrics()">Deselect
                                        all</button>
                                </ng-template>
                            </ng-select>
                        </div>
                        <div *ngIf="fMetrics.errors?.required && fMetrics.touched" class="error-txt">
                            Please select at least one metric
                        </div>
                    </div>
                </div>

                <!-- Select time-range -->
                <div class="form-row mt-2">
                    <div class="form-group col-sm-8">
                        <div class="input-group input-group-sm" (click)="datepicker.toggle()">
                            <div class="input-group-prepend">
                                <span class="input-group-text" (click)="ignore($event)">Timespan</span>
                            </div>
                            <input type="text" class="form-control dp pointer" placeholder="dd/mm/yyyy - dd/mm/yyyy"
                                formControlName="timespan" required />
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary " (click)="setAllTime($event)">
                                    All data
                                </button>
                            </div>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary calendar rounded-right"
                                    (click)="toggleDate($event)" #dpTarget>
                                    <fa-icon icon="calendar-alt"></fa-icon>
                                </button>
                            </div>
                            <div *ngIf="fTimespan.errors?.required && fTimespan.touched" class="error-txt">
                                Please choose a timespan
                            </div>
                            <div *ngIf="fTimespan.errors?.pattern && fTimespan.touched" class="error-txt">
                                Timespan must be of the form <code>dd/mm/yyyy - dd/mm/yyyy</code>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-sm-2">
                        <button type="button" class="btn btn-sm btn-secondary" (click)="openFilterPanel()">
                            <span>
                                Filter editor
                                <fa-icon icon="circle" class="ml-1" [class.active]="filterActive"
                                    [class.inactive]="!filterActive">
                                </fa-icon>
                            </span>
                        </button>
                    </div>
                    <div class="form-group col-sm-2 text-right">
                        <button class="btn btn-sm btn-outline-danger" type="submit"
                            [disabled]="removalForm.invalid">Delete
                            selected
                            data</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>